name: repro_pipeline

on:
  push:
    branches: [ci_cd  ]
  pull_request:
    branches: [ main ]
jobs:
  repro_pipeline:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ§  Clonar repositorio
      uses: actions/checkout@v4

    - name: ğŸ Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: ğŸ“¦ Instalar dependencias
      run: |
        pip install -r requirements.txt
        pip install dvc[all]

    - name: ğŸ” Configurar credenciales de DagsHub
      env:
        DAGSHUB_USER: ${{ secrets.DAGSHUB_USER }}
        DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      run: |
        echo "machine dagshub.com login $DAGSHUB_USER password $DAGSHUB_TOKEN" > ~/.netrc
        echo "DAGSHUB_USER=$DAGSHUB_USER" >> $GITHUB_ENV
        echo "DAGSHUB_TOKEN=$DAGSHUB_TOKEN" >> $GITHUB_ENV

    - name: ğŸ” Configurar credenciales S3 (para DVC)
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.DAGSHUB_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.DAGSHUB_SECRET_ACCESS_KEY }}
      run: |
        echo "Exportando credenciales S3 para DVC..."
        echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" >> $GITHUB_ENV
        echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" >> $GITHUB_ENV
        echo "âœ… Credenciales cargadas"

    - name: ğŸ” Probar conexiÃ³n con DagsHub
      run: |
        echo "Probando conexiÃ³n con DagsHub..."
        dvc remote list
        dvc list .   # muestra quÃ© archivos estÃ¡n versionados
        echo "âœ… ConexiÃ³n DVC OK"

    - name: ğŸ“¥ Descargar datos versionados (DVC)
      run: dvc pull


    - name: âš™ï¸ Ejecutar pipeline TelcoVision
      run: dvc repro

    - name: ğŸ“Š Mostrar mÃ©tricas
      run: cat metrics/metrics.json

    - name: ğŸ“¥ Pushear los datos (DVC)
      run: dvc push


  
  Validacion_mejor_metrica:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ§  Clonar repositorio
      uses: actions/checkout@v4

    - name: ğŸ Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: ğŸ“¦ Instalar dependencias
      run: |
        pip install -r requirements.txt
        pip install dvc[all]

    - name: ğŸ” Configurar credenciales de DagsHub
      env:
        DAGSHUB_USER: ${{ secrets.DAGSHUB_USER }}
        DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      run: |
        echo "machine dagshub.com login $DAGSHUB_USER password $DAGSHUB_TOKEN" > ~/.netrc
        echo "DAGSHUB_USER=$DAGSHUB_USER" >> $GITHUB_ENV
        echo "DAGSHUB_TOKEN=$DAGSHUB_TOKEN" >> $GITHUB_ENV

    - name: ğŸ” Configurar credenciales S3 (para DVC)
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.DAGSHUB_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.DAGSHUB_SECRET_ACCESS_KEY }}
      run: |
        echo "Exportando credenciales S3 para DVC..."
        echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" >> $GITHUB_ENV
        echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" >> $GITHUB_ENV
        echo "âœ… Credenciales cargadas"

    - name: ğŸ” Probar conexiÃ³n con DagsHub
      run: |
        echo "Probando conexiÃ³n con DagsHub..."
        dvc remote list
        dvc list .   # muestra quÃ© archivos estÃ¡n versionados
        echo "âœ… ConexiÃ³n DVC OK"

    - name: ğŸ“¥ Descargar datos versionados (DVC)
      run: dvc pull

    - name: ğŸ“¦ Guardar mÃ©tricas actuales de main
      run: |
        cp metrics/metrics.json metrics/metrics_main.json  

    - name: âš™ï¸ Ejecutar pipeline TelcoVision
      run: dvc repro

    - name: ğŸ“Š Mostrar mÃ©tricas
      run: cat metrics/metrics.json


    - name: ğŸ” Comparar mÃ©tricas con main
      run: python src/compare_metrics.py

    - name: ğŸ“¥ Pushear los datos (DVC)
      run: dvc push  